rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // gw.impact7.kr 도메인 Google Workspace 계정만 허용
    function isAuthorized() {
      return request.auth != null
        && (request.auth.token.email.matches('.*@gw\\.impact7\\.kr') || request.auth.token.email.matches('.*@impact7\\.kr'));
    }

    // 학생 마스터 컬렉션
    match /students/{docId} {
      allow read, write: if isAuthorized();

      // 메모 서브컬렉션
      match /memos/{memoId} {
        allow read, write: if isAuthorized();
      }
    }

    // 이력 로그: 읽기 + 생성만 허용, 수정/삭제 불가 (감사 로그 무결성 보장)
    match /history_logs/{logId} {
      allow read, create: if isAuthorized();
      allow update, delete: if false;
    }
  }
}
