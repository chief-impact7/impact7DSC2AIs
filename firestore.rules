rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // =========================================================================
    // 인증: 로그인 여부만 확인 (도메인 검증은 클라이언트 + 아래 개별 규칙에서)
    // =========================================================================
    function isLoggedIn() {
      return request.auth != null;
    }

    function isAuthorized() {
      return isLoggedIn()
        && request.auth.token.email_verified == true
        && (request.auth.token.email.matches('.*@gw\\.impact7\\.kr$')
            || request.auth.token.email.matches('.*@impact7\\.kr$'));
    }

    // =========================================================================
    // 학생 마스터 컬렉션
    // =========================================================================
    match /students/{docId} {

      function hasRequiredStudentFields() {
        let data = request.resource.data;
        return data.keys().hasAll(['name', 'parent_phone_1', 'branch', 'status', 'enrollments'])
          && data.name is string
          && data.name.size() > 0
          && data.parent_phone_1 is string
          && data.parent_phone_1.size() > 0
          && data.branch is string
          && data.status is string
          && data.status in ['등원예정', '재원', '실휴원', '가휴원', '퇴원']
          && data.enrollments is list;
      }

      function hasOnlyAllowedStudentFields() {
        let allowed = [
          'name', 'level', 'school', 'grade',
          'student_phone', 'parent_phone_1', 'parent_phone_2',
          'branch', 'status', 'enrollments',
          'pause_start_date', 'pause_end_date',
          'day', 'class_type', 'level_code', 'level_symbol', 'class_number',
          'start_date', 'special_start_date', 'special_end_date'
        ];
        return request.resource.data.keys().hasOnly(allowed);
      }

      function withinSizeLimit() {
        return request.resource.data.keys().size() <= 20;
      }

      allow read: if isLoggedIn();

      allow create: if isLoggedIn()
        && hasRequiredStudentFields()
        && hasOnlyAllowedStudentFields()
        && withinSizeLimit();

      allow update: if isLoggedIn()
        && hasRequiredStudentFields()
        && hasOnlyAllowedStudentFields()
        && withinSizeLimit();

      allow delete: if isLoggedIn();

      // 메모 서브컬렉션
      match /memos/{memoId} {

        function hasRequiredMemoFields() {
          let data = request.resource.data;
          return data.keys().hasAll(['text', 'author', 'created_at'])
            && data.text is string
            && data.text.size() > 0
            && data.text.size() <= 2000
            && data.author is string;
        }

        function hasOnlyAllowedMemoFields() {
          return request.resource.data.keys().hasOnly(['text', 'author', 'created_at']);
        }

        allow read: if isLoggedIn();

        allow create: if isLoggedIn()
          && hasRequiredMemoFields()
          && hasOnlyAllowedMemoFields();

        allow update: if false;
        allow delete: if isLoggedIn();
      }
    }

    // =========================================================================
    // 이력 로그: 읽기 + 생성만, 수정/삭제 불가
    // =========================================================================
    match /history_logs/{logId} {

      function hasRequiredLogFields() {
        let data = request.resource.data;
        return data.keys().hasAll(['doc_id', 'change_type', 'before', 'after', 'google_login_id', 'timestamp'])
          && data.doc_id is string
          && data.doc_id.size() > 0
          && data.change_type is string
          && data.change_type in ['ENROLL', 'UPDATE', 'WITHDRAW']
          && data.before is string
          && data.after is string
          && data.google_login_id is string
          && data.google_login_id.size() > 0;
      }

      function hasOnlyAllowedLogFields() {
        return request.resource.data.keys().hasOnly([
          'doc_id', 'change_type', 'before', 'after', 'google_login_id', 'timestamp'
        ]);
      }

      allow read: if isLoggedIn();

      allow create: if isLoggedIn()
        && hasRequiredLogFields()
        && hasOnlyAllowedLogFields();

      allow update, delete: if false;
    }

    // =========================================================================
    // 사용자 역할: 자기 문서만 읽기, 생성/수정/삭제는 콘솔에서만
    // =========================================================================
    match /users/{userEmail} {
      allow read: if isLoggedIn()
        && request.auth.token.email == userEmail;

      allow create, update, delete: if false;
    }

    // =========================================================================
    // 일별 통계 스냅샷: 읽기/생성은 로그인 유저, 수정/삭제 불가
    // (admin 제한은 앱 레벨에서 UI + 함수로 처리)
    // =========================================================================
    match /daily_stats/{dateId} {

      allow read: if isLoggedIn();

      allow create: if isLoggedIn()
        && request.resource.data.keys().hasAll(['date', 'generated_at', 'generated_by', 'total', 'active_total', 'by_status'])
        && request.resource.data.keys().hasOnly([
             'date', 'generated_at', 'generated_by', 'total', 'active_total',
             'by_status', 'by_branch', 'by_level', 'by_class_code',
             'by_status_branch', 'by_level_symbol_branch'
           ]);

      allow update, delete: if false;
    }

    // =========================================================================
    // 기본 거부
    // =========================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
